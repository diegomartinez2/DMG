
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Hands-on-session 3 &#8212; python-sscha 1.2 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="PYTHON-SSCHA USER GUIDE" href="index1.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="hands-on-session-3">
<h1>Hands-on-session 3<a class="headerlink" href="#hands-on-session-3" title="Permalink to this headline">¶</a></h1>
<div class="section" id="calculations-of-second-order-phase-transitions-with-the-sscha">
<h2>Calculations of second-order phase transitions with the SSCHA<a class="headerlink" href="#calculations-of-second-order-phase-transitions-with-the-sscha" title="Permalink to this headline">¶</a></h2>
<p>In this hands-on we provide ready to use examples to calculate second-order phase transitions with SSCHA calculations.</p>
<div class="section" id="structural-instability-calculation-of-the-hessian">
<h3>Structural instability: calculation of the Hessian<a class="headerlink" href="#structural-instability-calculation-of-the-hessian" title="Permalink to this headline">¶</a></h3>
<p>This tutorial explains how to search for structural instabilities with a SSCHA calculation.</p>
<p>The SSCHA method provides a complete theoretical framework to study second-order phase transitions for structural instabilities.</p>
<p>According to Landau’s theory of second-order phase transitions, a phase transition occurs when the free energy curvature around the high-symmetry structure on the direction of the order parameter becomes negative:</p>
<div class="figure" id="id4">
<span id="fig-second-order"></span><a class="reference internal image-reference" href="_images/second_order.png"><img alt="Second order." src="_images/second_order.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 1 </span><span class="caption-text">Landau’s theory of second-order phase transitions.</span></p>
</div>
<p>For structural phase transitions, the order parameter is associated to phonon atomic displacements:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial^2 F}{\partial R_a \partial R_b}\]</div>
<p>So we just need to calculate the Free energy Hessian. the SSCHA provides an analytical equation for the free energy Hessian, derived by Raffaello Bianco in the work <a class="reference external" href="https://journals.aps.org/prb/abstract/10.1103/PhysRevB.96.014111">Bianco et. al. Phys. Rev. B 96, 014111</a>.
The free energy curvature can be written in matrix form as:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial^2 F}{\partial {R_a}\partial {R_b}} = \Phi_{ab} + \sum_{cdef} \stackrel{(3)}{\Phi}_{acd}[1 - \Lambda\stackrel{(4)}{\Phi}]^{-1}_{cdef} \stackrel{(3)}{\Phi}_{efb}\]</div>
<p>Fortunately, this complex equation can be evaluated from the ensemble with a simple function call:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_free_energy_hessian</span><span class="p">()</span>
</pre></div>
</div>
<p>Lets see a practical example, first we calculate the SSCHA dynamical matrix for the SnTe:</p>
<p>To speedup the calculations, we will use a force-field that can mimic the physics of ferroelectric transitions in FCC lattices.</p>
<p>Lets do something different an write it as an object (Object Oriented Program).</p>
<p>We begin from the bottom with the old python trick for code re-usability:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="c1">#main code goes here</span>
<span class="k">return</span> <span class="mi">0</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">sys</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">))</span>
</pre></div>
</div>
<p>and now we put the top part of the code, we import some libraries:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1">#  SSCHA_exercise.py</span>
<span class="c1">#</span>
<span class="c1"># Import the cellconstructor stuff</span>
<span class="kn">import</span> <span class="nn">cellconstructor</span> <span class="k">as</span> <span class="nn">CC</span>
<span class="kn">import</span> <span class="nn">cellconstructor.Phonons</span>
<span class="kn">import</span> <span class="nn">cellconstructor.ForceTensor</span>
<span class="kn">import</span> <span class="nn">cellconstructor.Structure</span>
<span class="kn">import</span> <span class="nn">cellconstructor.Spectral</span>

<span class="c1"># Import the modules of the force field</span>
<span class="kn">import</span> <span class="nn">fforces</span> <span class="k">as</span> <span class="nn">ff</span>
<span class="kn">import</span> <span class="nn">fforces.Calculator</span>

<span class="c1"># Import the modules to run the sscha</span>
<span class="kn">import</span> <span class="nn">sscha</span><span class="o">,</span> <span class="nn">sscha.Ensemble</span><span class="o">,</span> <span class="nn">sscha.SchaMinimizer</span>
<span class="kn">import</span> <span class="nn">sscha.Relax</span><span class="o">,</span> <span class="nn">sscha.Utilities</span>

<span class="kn">import</span> <span class="nn">spglib</span>
<span class="kn">from</span> <span class="nn">ase.visualize</span> <span class="kn">import</span> <span class="n">view</span>

<span class="c1"># Import Matplotlib to plot</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">import</span> <span class="nn">timeit</span>
</pre></div>
</div>
<p>Now we need to calculate the SSCHA dynamical matrix. For that we can use this object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SnTe_initial</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">file_ForceFields</span><span class="p">,</span><span class="n">file_dyn</span><span class="p">,</span><span class="n">nqirr</span><span class="p">,</span><span class="n">configurations</span><span class="p">,</span><span class="n">sobol</span><span class="p">,</span><span class="n">sobol_scatter</span><span class="p">):</span>
      <span class="c1"># Load the dynamical matrix for the force field</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ff_dyn</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">Phonons</span><span class="o">.</span><span class="n">Phonons</span><span class="p">(</span><span class="n">file_ForceFields</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

      <span class="c1"># Setup the forcefield with the correct parameters</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">Calculator</span><span class="o">.</span><span class="n">ToyModelCalculator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ff_dyn</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">type_cal</span> <span class="o">=</span> <span class="s2">&quot;pbtex&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">p3</span> <span class="o">=</span> <span class="mf">0.036475</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">p4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.022</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">p4x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.014</span>

      <span class="c1"># Initialization of the SSCHA matrix</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">Phonons</span><span class="o">.</span><span class="n">Phonons</span><span class="p">(</span><span class="n">file_dyn</span><span class="p">,</span> <span class="n">nqirr</span><span class="p">)</span>
      <span class="c1"># Flip the imaginary frequencies into real ones</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha</span><span class="o">.</span><span class="n">ForcePositiveDefinite</span><span class="p">()</span>
      <span class="c1"># Apply the ASR and the symmetry group</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha</span><span class="o">.</span><span class="n">Symmetrize</span><span class="p">()</span>
      <span class="c1"># Set some parameters and flags</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">configurations</span><span class="o">=</span><span class="n">configurations</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sobol</span> <span class="o">=</span> <span class="n">sobol</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sobol_scatter</span> <span class="o">=</span> <span class="n">sobol_scatter</span>

  <span class="k">def</span> <span class="nf">ensemble_sscha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">T</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">sscha</span><span class="o">.</span><span class="n">Ensemble</span><span class="o">.</span><span class="n">Ensemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha</span><span class="p">,</span> <span class="n">T0</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="n">supercell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha</span><span class="o">.</span><span class="n">GetSupercell</span><span class="p">())</span>
      <span class="c1"># Detect space group</span>
      <span class="n">symm</span><span class="o">=</span><span class="n">spglib</span><span class="o">.</span><span class="n">get_spacegroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_ase_atoms</span><span class="p">(),</span> <span class="mf">0.005</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial SG = &#39;</span><span class="p">,</span> <span class="n">symm</span><span class="p">)</span>


  <span class="k">def</span> <span class="nf">minimizing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">file_frequencies</span><span class="p">,</span><span class="n">file_matrix</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">minim</span> <span class="o">=</span> <span class="n">sscha</span><span class="o">.</span><span class="n">SchaMinimizer</span><span class="o">.</span><span class="n">SSCHA_Minimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="p">)</span>

      <span class="c1"># Lets setup the minimization on the fourth root</span>
      <span class="c1">#self.minim.root_representation = &quot;root4&quot; # Other possibilities are &#39;normal&#39; and &#39;sqrt&#39;</span>

      <span class="c1"># To work correctly with the root4, we must deactivate the preconditioning on the dynamical matrix</span>
      <span class="c1">#self.minim.precond_dyn = False</span>

      <span class="c1"># Now we setup the minimization parameters</span>
      <span class="c1"># Since we are quite far from the correct solution, we will use a small optimization step</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">min_step_dyn</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># If the minimization ends with few steps (less than 10), decrease it, if it takes too much, increase it</span>

      <span class="c1"># We decrease the Kong-Liu effective sample size below which the population is stopped</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">kong_liu_ratio</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Default 0.5</span>
      <span class="c1"># We relax the structure</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">relax</span> <span class="o">=</span> <span class="n">sscha</span><span class="o">.</span><span class="n">Relax</span><span class="o">.</span><span class="n">SSCHA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minim</span><span class="p">,</span>
                        <span class="n">ase_calculator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="p">,</span>
                        <span class="n">N_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configurations</span><span class="p">,</span>
                        <span class="n">max_pop</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>

      <span class="c1"># Setup the custom function to print the frequencies at each step of the minimization</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">io_func</span> <span class="o">=</span> <span class="n">sscha</span><span class="o">.</span><span class="n">Utilities</span><span class="o">.</span><span class="n">IOInfo</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">io_func</span><span class="o">.</span><span class="n">SetupSaving</span><span class="p">(</span><span class="n">file_frequencies</span><span class="p">)</span> <span class="c1"># The file that will contain the frequencies is frequencies.dat</span>

      <span class="c1"># Now tell relax to call the function to save the frequencies after each iteration</span>
      <span class="c1"># CFP stands for Custom Function Post (Post = after the minimization step)</span>
      <span class="c1">#self.relax.setup_custom_functions(custom_function_post = self.io_func.CFP_SaveFrequencies)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">setup_custom_functions</span><span class="p">(</span><span class="n">custom_function_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_func</span><span class="o">.</span><span class="n">CFP_SaveAll</span><span class="p">)</span>
      <span class="c1"># Finally we do all the free energy calculations.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">relax</span><span class="p">(</span><span class="n">sobol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobol</span><span class="p">,</span> <span class="n">sobol_scramble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobol_scatter</span><span class="p">)</span>
      <span class="c1">#self.relax.vc_relax(static_bulk_modulus=40, fix_volume = False)</span>

      <span class="c1"># Save the final dynamical matrix</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">save_qe</span><span class="p">(</span><span class="n">file_matrix</span><span class="p">)</span>
      <span class="c1"># Detect space group</span>
      <span class="n">symm</span><span class="o">=</span><span class="n">spglib</span><span class="o">.</span><span class="n">get_spacegroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_ase_atoms</span><span class="p">(),</span> <span class="mf">0.005</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New SG = &#39;</span><span class="p">,</span> <span class="n">symm</span><span class="p">)</span>
      <span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_ase_atoms</span><span class="p">())</span>
</pre></div>
</div>
<p>We’ve seen most of this before, so let’s review what’s there in detail:</p>
<ol class="arabic">
<li><p class="first">First this object is initialized in “__init__” where the toy model potential is set for the next calculations.
This force field needs the harmonic dynamical matrix to be initialized, and the higher order parameters.
Finally, the dynamical matrix for the minimization is loaded and readied. Since we are studying a system that has a spontaneous symmetry breaking at low temperature, the harmonic dynamical matrices will have imaginary phonons. We must enforce phonons to be positive definite to start a SSCHA minimization.</p>
</li>
<li><p class="first">The next function of this object “ensemble_sscha” just creates the ensembles for the specified temperature. As an extra, we also look for the space group of the structure.</p>
</li>
<li><p class="first">Next comes the minimization function. In the “minimizing” function we can set the fourth root minimization, in which, instead of optimizing the auxiliary dynamical matrices themselves, we will optimize their fourth root.</p>
<div class="math notranslate nohighlight">
\[\Phi = \left({\sqrt[4]{\Phi}}\right)^4\]</div>
<p>This constrains the dynamical matrix to be positive definite during the minimization.
Next the automatic relaxation is set with the option here to use the Sobol sequence for the ensemble generation.</p>
<p>We also set a custom function to save the frequencies at each iteration, to see how they evolves. This is very useful to understand if the algorithm is converged or not.</p>
<p>Then the dynamical matrix of the converged minimization is saved in a file, and finally we take a look at the space group and the structure.</p>
</li>
</ol>
<p>Now we fill the main function with this new object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
  <span class="c1">#Setting the variables:</span>
  <span class="c1">#Setting the temperature in Kelvin:</span>
  <span class="n">Temperature</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="c1">#Setting the number of configurations:</span>
  <span class="n">configuration_number</span> <span class="o">=</span> <span class="mi">50</span>
  <span class="c1">#Setting the names and location of the files:</span>
  <span class="n">Files_ForceFields</span> <span class="o">=</span> <span class="s2">&quot;ffield_dynq&quot;</span>
  <span class="n">Files_dyn_SnTe</span> <span class="o">=</span> <span class="s2">&quot;ffield_dynq&quot;</span>
  <span class="c1">#Set the number of irreducible q (reated to the supercell size):</span>
  <span class="n">nqirr</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="c1">#Setting the frequencies output file:</span>
  <span class="n">File_frequencies</span> <span class="o">=</span> <span class="s2">&quot;frequencies.dat&quot;</span>
  <span class="c1">#Setting the dynamical matrix output filename:</span>
  <span class="n">File_final_dyn</span> <span class="o">=</span> <span class="s2">&quot;final_sscha_T</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Temperature</span><span class="p">))</span>
  <span class="n">sobol</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">sobol_scatter</span> <span class="o">=</span> <span class="kc">False</span>

  <span class="n">Calculus</span> <span class="o">=</span> <span class="n">SnTe_initial</span><span class="p">(</span><span class="n">Files_ForceFields</span><span class="p">,</span><span class="n">Files_dyn_SnTe</span><span class="p">,</span><span class="n">nqirr</span><span class="p">,</span><span class="n">configuration_number</span><span class="p">,</span><span class="n">sobol</span><span class="p">,</span><span class="n">sobol_scatter</span><span class="p">)</span>
  <span class="n">Calculus</span><span class="o">.</span><span class="n">ensemble_sscha</span><span class="p">(</span><span class="n">Temperature</span><span class="p">)</span>
  <span class="n">Calculus</span><span class="o">.</span><span class="n">minimizing</span><span class="p">(</span><span class="n">File_frequencies</span><span class="p">,</span><span class="n">File_final_dyn</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Temperature</span><span class="p">)))</span>

  <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
<p>This code will calculate the SSCHA minimization with the “ff_calculator”. We cat use “sscha-plot-data.py” to take a look at the minimization.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>sscha-plot-data.py<span class="w"> </span>frequencies.dat
</pre></div>
</div>
<p>Note: this force field model is not able to compute stress, as it is defined only at fixed volume, so we cannot use it for a variable cell relaxation.</p>
<p><strong>Now we can search for instabilities.</strong></p>
<p>If we have a very small mode in the SSCHA frequencies, it means that associated to that mode we have huge fluctuations. This can indicate an instability. However, to test this we need to compute the free energy curvature along this mode. This can be obtained in one shot thanks to the theory developed in <a class="reference external" href="https://journals.aps.org/prb/abstract/10.1103/PhysRevB.96.014111">Bianco et. al. Phys. Rev. B 96, 014111.</a></p>
<p>For that we create another object, “Search_instabilities” to do the job.</p>
<p>[…]</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Search_instabilities</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">files_ForceFields</span><span class="p">,</span><span class="n">files_dyn</span><span class="p">,</span><span class="n">nqirr</span><span class="p">):</span>
        <span class="c1"># Load the dynamical matrix for the force field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_dyn</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">Phonons</span><span class="o">.</span><span class="n">Phonons</span><span class="p">(</span><span class="n">files_ForceFields</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Setup the forcefield with the correct parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">Calculator</span><span class="o">.</span><span class="n">ToyModelCalculator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ff_dyn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">type_cal</span> <span class="o">=</span> <span class="s2">&quot;pbtex&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">p3</span> <span class="o">=</span> <span class="mf">0.036475</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">p4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.022</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">p4x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.014</span>

        <span class="c1"># Initialization of the SSCHA matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">Phonons</span><span class="o">.</span><span class="n">Phonons</span><span class="p">(</span><span class="n">files_dyn</span><span class="p">,</span> <span class="n">nqirr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha</span><span class="o">.</span><span class="n">ForcePositiveDefinite</span><span class="p">()</span>

        <span class="c1"># Apply also the ASR and the symmetry group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha</span><span class="o">.</span><span class="n">Symmetrize</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_dyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File_final_dyn</span><span class="p">,</span><span class="n">nqirr</span><span class="p">):</span>
        <span class="c1"># The SSCHA dynamical matrix is needed (the one after convergence)</span>
        <span class="c1"># We reload the final result (no need to rerun the sscha minimization)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha_final</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">Phonons</span><span class="o">.</span><span class="n">Phonons</span><span class="p">(</span><span class="n">File_final_dyn</span><span class="p">,</span> <span class="n">nqirr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ensemble_sscha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">T</span><span class="p">):</span>
        <span class="c1"># We reset the ensemble</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">sscha</span><span class="o">.</span><span class="n">Ensemble</span><span class="o">.</span><span class="n">Ensemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha_final</span><span class="p">,</span> <span class="n">T0</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="n">supercell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha_final</span><span class="o">.</span><span class="n">GetSupercell</span><span class="p">())</span>

        <span class="c1"># We need a bigger ensemble to properly compute the hessian</span>
        <span class="c1"># Here we will use 10000 configurations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">sobol</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">sobol_scramble</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1">#self.ensemble.generate(10000, sobol = False)</span>
        <span class="c1">#We could also load the ensemble with ensemble.load(&quot;data_ensemble_final&quot;, N = 100, population = 5)</span>

    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We now compute forces and energies using the force field calculator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_energy_forces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="p">,</span> <span class="n">compute_stress</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hessian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">T</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating the importance sampling...&quot;</span><span class="p">)</span>
        <span class="c1"># If the sscha matrix was not the one used to compute the ensemble</span>
        <span class="c1"># We must update the ensemble weights</span>
        <span class="c1"># We can also use this function to simulate a different temperature.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn_sscha_final</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="c1"># ----------- COMPUTE THE FREE ENERGY HESSIAN -----------</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing the free energy hessian...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_hessian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_free_energy_hessian</span><span class="p">(</span><span class="n">include_v4</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># We neglect high-order four phonon scattering</span>
        <span class="c1">#self.dyn_hessian = self.ensemble.get_free_energy_hessian(include_v4 = True,</span>
        <span class="c1">#                                          get_full_hessian = True,verbose = True) # Full calculus</span>
        <span class="c1"># We can save the free energy hessian as a dynamical matrix in quantum espresso format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_hessian</span><span class="o">.</span><span class="n">save_qe</span><span class="p">(</span><span class="s2">&quot;hessian&quot;</span><span class="p">)</span>
        <span class="c1"># -------------------------------------------------------</span>
        <span class="c1"># We calculate the frequencies of the hessian:</span>
        <span class="n">w_hessian</span><span class="p">,</span> <span class="n">pols_hessian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_hessian</span><span class="o">.</span><span class="n">DiagonalizeSupercell</span><span class="p">()</span>

        <span class="c1"># Print all the frequency converting them into cm-1 (They are in Ry)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:16.4f}</span><span class="s2"> cm-1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">CC</span><span class="o">.</span><span class="n">Units</span><span class="o">.</span><span class="n">RY_TO_CM</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">w_hessian</span><span class="p">]))</span>
</pre></div>
</div>
<p>Lets see what this code do:</p>
<ol class="arabic">
<li><p class="first">In the initialization function the “ff_calculator” toy potential is defined as we have seen in the previous object.</p>
</li>
<li><p class="first">In “load_dyn” function, it will load the dynamical matrix calculated previously with the “ff_calculator” toy potential, so there is no need to calculate it again.</p>
</li>
<li><p class="first">Then, as the Hessian calculation is more sensible, we generate a new ensemble with more configurations in “ensemble_sscha”.
To compute the hessian we will use an ensemble of 10000 configurations.
Note here that we can use less if we use Sobol sequence or we can load a previously generated ensemble.</p>
</li>
<li><p class="first">We now compute forces and energies using the force field calculator.</p>
</li>
<li><p class="first">Finally the free energy hessian is calculated in the “hessian” function.
We can choose if we neglect or not in the calculation the four phonon scattering process. Four phonon scattering processes require a huge memory allocation for big systems, that scales as (3⋅N)^4 with N the number of atoms in the supercell. Moreover, it may require also more configurations to converge.</p>
<p>In almost all the systems we studied up to now, we found this four phonon scattering at high order to be negligible. We remark, that the SSCHA minimization already includes four phonon scattering at the lowest order perturbation theory, thus neglecting this term only affects combinations of one or more four phonon scattering with two three phonon scatterings (high order diagrams). For more details, see <a class="reference external" href="https://journals.aps.org/prb/abstract/10.1103/PhysRevB.96.014111">Bianco et. al. Phys. Rev. B 96, 014111.</a></p>
<p>We can then print the frequencies of the hessian. If an imaginary frequency is present, then the system wants to spontaneously break the high symmetry phase.</p>
</li>
</ol>
<p>The frequencies in the free energy hessian are temperature dependent.</p>
<p>Lets put this object into the main function and calculate:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
  <span class="c1">#Setting the variables:</span>
  <span class="c1">#Setting the temperature in Kelvin:</span>
  <span class="n">Temperature</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="c1">#Setting the number of configurations:</span>
  <span class="n">configuration_number</span> <span class="o">=</span> <span class="mi">50</span>
  <span class="c1">#Setting the names and location of the files:</span>
  <span class="n">Files_ForceFields</span> <span class="o">=</span> <span class="s2">&quot;ffield_dynq&quot;</span>
  <span class="n">Files_dyn_SnTe</span> <span class="o">=</span> <span class="s2">&quot;ffield_dynq&quot;</span>
  <span class="c1">#Set the number of irreducible q (reated to the supercell size):</span>
  <span class="n">nqirr</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="c1">#Setting the frequencies output file:</span>
  <span class="n">File_frequencies</span> <span class="o">=</span> <span class="s2">&quot;frequencies.dat&quot;</span>
  <span class="c1">#Setting the dynamical matrix output filename:</span>
  <span class="n">File_final_dyn</span> <span class="o">=</span> <span class="s2">&quot;final_sscha_T</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Temperature</span><span class="p">))</span>
  <span class="n">sobol</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">sobol_scatter</span> <span class="o">=</span> <span class="kc">False</span>

  <span class="c1">#We can comment this if we already made the sscha minimization</span>
  <span class="c1">#Calculus = SnTe_initial(Files_ForceFields,Files_dyn_SnTe,nqirr,configuration_number,sobol,sobol_scatter)</span>
  <span class="c1">#Calculus.ensemble_sscha(Temperature)</span>
  <span class="c1">#Calculus.minimizing(File_frequencies,File_final_dyn.format(int(Temperature)))</span>

  <span class="c1">#Now we can search for structural instabilities:</span>
  <span class="n">Unstable</span> <span class="o">=</span> <span class="n">Search_instabilities</span><span class="p">(</span><span class="n">Files_ForceFields</span><span class="p">,</span><span class="n">Files_dyn_SnTe</span><span class="p">,</span><span class="n">nqirr</span><span class="p">)</span>
  <span class="n">Unstable</span><span class="o">.</span><span class="n">load_dyn</span><span class="p">(</span><span class="n">File_final_dyn</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Temperature</span><span class="p">),</span><span class="n">nqirr</span><span class="p">)</span>
  <span class="n">Unstable</span><span class="o">.</span><span class="n">ensemble_sscha</span><span class="p">(</span><span class="n">Temperature</span><span class="p">)</span>
  <span class="n">Unstable</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span>
  <span class="n">Unstable</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">Temperature</span><span class="p">)</span>

  <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
<p>We can look at the eigenmodes of the free energy hessian to check if we have imaginary phonons. If there are negative frequencies then we found an instability. You can check what happens if you include the fourth order.</p>
</div>
<div class="section" id="phase-transition">
<h3>Phase transition:<a class="headerlink" href="#phase-transition" title="Permalink to this headline">¶</a></h3>
<p>Up to now we studied the system at T=0K and we found that there is an instability. However, we can repeat the minimization at many temperatures, and track the phonon frequency to see which is the temperature at which the system becomes stable.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Hessian_Vs_Temperature</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">T0</span><span class="p">,</span><span class="n">temperatures_i</span><span class="p">,</span><span class="n">files_ForceFields</span><span class="p">,</span><span class="n">configurations</span><span class="p">,</span><span class="n">sobol</span><span class="p">,</span><span class="n">sobol_scatter</span><span class="p">):</span>
        <span class="c1"># Load the dynamical matrix for the force field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_dyn</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">Phonons</span><span class="o">.</span><span class="n">Phonons</span><span class="p">(</span><span class="n">files_ForceFields</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Setup the forcefield with the correct parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">Calculator</span><span class="o">.</span><span class="n">ToyModelCalculator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ff_dyn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">type_cal</span> <span class="o">=</span> <span class="s2">&quot;pbtex&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">p3</span> <span class="o">=</span> <span class="mf">0.036475</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">p4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.022</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="o">.</span><span class="n">p4x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.014</span>
        <span class="c1"># Define the temperatures, from 50 to 300 K, 6 temperatures</span>
        <span class="c1">#self.temperatures = np.linspace(50, 300, 6)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperatures</span> <span class="o">=</span> <span class="n">temperatures_i</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lowest_hessian_mode</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowest_sscha_mode</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Perform a simulation at each temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_old</span> <span class="o">=</span> <span class="n">T0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurations</span> <span class="o">=</span> <span class="n">configurations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sobol</span> <span class="o">=</span> <span class="n">sobol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sobol_scatter</span> <span class="o">=</span> <span class="n">sobol_scatter</span>

    <span class="k">def</span> <span class="nf">cycle_T</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Files_final_dyn</span><span class="p">,</span><span class="n">nqirr</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">Temperature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperatures</span><span class="p">:</span>
            <span class="c1"># Load the starting dynamical matrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dyn</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">Phonons</span><span class="o">.</span><span class="n">Phonons</span><span class="p">(</span><span class="n">Files_final_dyn</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_old</span><span class="p">)),</span> <span class="n">nqirr</span><span class="p">)</span>

            <span class="c1"># Prepare the ensemble</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">sscha</span><span class="o">.</span><span class="n">Ensemble</span><span class="o">.</span><span class="n">Ensemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="p">,</span> <span class="n">T0</span> <span class="o">=</span> <span class="n">Temperature</span><span class="p">,</span> <span class="n">supercell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">GetSupercell</span><span class="p">())</span>

            <span class="c1"># Prepare the minimizer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minim</span> <span class="o">=</span> <span class="n">sscha</span><span class="o">.</span><span class="n">SchaMinimizer</span><span class="o">.</span><span class="n">SSCHA_Minimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">min_step_struc</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">min_step_dyn</span> <span class="o">=</span> <span class="mf">0.002</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">kong_liu_ratio</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">meaningful_factor</span> <span class="o">=</span> <span class="mf">0.000001</span>
            <span class="c1">#minim.root_representation = &quot;root4&quot;</span>
            <span class="c1">#minim.precond_dyn = False</span>
            <span class="c1">#self.minim.minim_struct = True</span>
            <span class="c1">#self.minim.neglect_symmetries = True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">enforce_sum_rule</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Lorenzo&#39;s solution to the error</span>

            <span class="c1"># Prepare the relaxer (through many population)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relax</span> <span class="o">=</span> <span class="n">sscha</span><span class="o">.</span><span class="n">Relax</span><span class="o">.</span><span class="n">SSCHA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minim</span><span class="p">,</span> <span class="n">ase_calculator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="p">,</span> <span class="n">N_configs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configurations</span><span class="p">,</span> <span class="n">max_pop</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

            <span class="c1"># Relax</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">relax</span><span class="p">(</span><span class="n">sobol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobol</span><span class="p">,</span> <span class="n">sobol_scramble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobol_scatter</span><span class="p">)</span>
            <span class="c1">#self.relax.relax()</span>

            <span class="c1"># Save the dynamical matrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">save_qe</span><span class="p">(</span><span class="n">Files_final_dyn</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Temperature</span><span class="p">)))</span>

            <span class="c1"># Detect space group</span>
            <span class="n">symm</span><span class="o">=</span><span class="n">spglib</span><span class="o">.</span><span class="n">get_spacegroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_ase_atoms</span><span class="p">(),</span> <span class="mf">0.005</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Current SG = &#39;</span><span class="p">,</span> <span class="n">symm</span><span class="p">,</span><span class="s1">&#39; at T=&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">Temperature</span><span class="p">))</span>

            <span class="c1"># Recompute the ensemble for the hessian calculation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">sscha</span><span class="o">.</span><span class="n">Ensemble</span><span class="o">.</span><span class="n">Ensemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">dyn</span><span class="p">,</span> <span class="n">T0</span> <span class="o">=</span> <span class="n">Temperature</span><span class="p">,</span> <span class="n">supercell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">GetSupercell</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configurations</span><span class="p">,</span> <span class="n">sobol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobol</span><span class="p">,</span> <span class="n">sobol_scramble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sobol_scatter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_energy_forces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ff_calculator</span><span class="p">,</span> <span class="n">compute_stress</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="c1">#gets the energies and forces from ff_calculator</span>

            <span class="c1">#update weights!!!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">dyn</span><span class="p">,</span> <span class="n">Temperature</span><span class="p">)</span>
            <span class="c1"># Get the free energy hessian</span>
            <span class="n">dyn_hessian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_free_energy_hessian</span><span class="p">(</span><span class="n">include_v4</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="c1">#free energy hessian as in Bianco paper 2017</span>
            <span class="n">dyn_hessian</span><span class="o">.</span><span class="n">save_qe</span><span class="p">(</span><span class="s2">&quot;hessian_T</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Temperature</span><span class="p">)))</span>

            <span class="c1"># Get the lowest frequencies for the sscha and the free energy hessian</span>
            <span class="n">w_sscha</span><span class="p">,</span> <span class="n">pols_sscha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">DiagonalizeSupercell</span><span class="p">()</span> <span class="c1">#dynamical matrix</span>
            <span class="c1"># Get the structure in the supercell</span>
            <span class="n">superstructure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">generate_supercell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="o">.</span><span class="n">minim</span><span class="o">.</span><span class="n">dyn</span><span class="o">.</span><span class="n">GetSupercell</span><span class="p">())</span> <span class="c1">#</span>

            <span class="c1"># Discard the acoustic modes</span>
            <span class="n">acoustic_modes</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">Methods</span><span class="o">.</span><span class="n">get_translations</span><span class="p">(</span><span class="n">pols_sscha</span><span class="p">,</span> <span class="n">superstructure</span><span class="o">.</span><span class="n">get_masses_array</span><span class="p">())</span>
            <span class="n">w_sscha</span> <span class="o">=</span> <span class="n">w_sscha</span><span class="p">[</span><span class="o">~</span><span class="n">acoustic_modes</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lowest_sscha_mode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">w_sscha</span><span class="p">)</span> <span class="o">*</span> <span class="n">CC</span><span class="o">.</span><span class="n">Units</span><span class="o">.</span><span class="n">RY_TO_CM</span><span class="p">)</span> <span class="c1"># Convert from Ry to cm-1</span>

            <span class="n">w_hessian</span><span class="p">,</span> <span class="n">pols_hessian</span> <span class="o">=</span> <span class="n">dyn_hessian</span><span class="o">.</span><span class="n">DiagonalizeSupercell</span><span class="p">()</span> <span class="c1">#recomputed dyn for hessian</span>
            <span class="c1"># Discard the acoustic modes</span>
            <span class="n">acoustic_modes</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">Methods</span><span class="o">.</span><span class="n">get_translations</span><span class="p">(</span><span class="n">pols_hessian</span><span class="p">,</span> <span class="n">superstructure</span><span class="o">.</span><span class="n">get_masses_array</span><span class="p">())</span>
            <span class="n">w_hessian</span> <span class="o">=</span> <span class="n">w_hessian</span><span class="p">[</span><span class="o">~</span><span class="n">acoustic_modes</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowest_hessian_mode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">w_hessian</span><span class="p">)</span> <span class="o">*</span> <span class="n">CC</span><span class="o">.</span><span class="n">Units</span><span class="o">.</span><span class="n">RY_TO_CM</span><span class="p">)</span> <span class="c1"># Convert from Ry to cm-1</span>
            <span class="c1">#print (&quot;\n&quot;.join([&quot;{:.4f} cm-1&quot;.format(w * CC.Units.RY_TO_CM) for w in pols_hessian]))</span>
            <span class="c1">#exit()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">t_old</span> <span class="o">=</span> <span class="n">Temperature</span>
        <span class="c1"># We prepare now the file to save the results</span>
        <span class="n">freq_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperatures</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">freq_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperatures</span>
        <span class="n">freq_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowest_sscha_mode</span>
        <span class="n">freq_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowest_hessian_mode</span>

        <span class="c1"># Save results on file</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_hessian_vs_temperature.dat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configurations</span><span class="p">),</span> <span class="n">freq_data</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;T [K]; SSCHA mode [cm-1]; Free energy hessian [cm-1]&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hessian_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_hessian_vs_temperature.dat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configurations</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span> <span class="o">=</span> <span class="mi">120</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hessian_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">hessian_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Min SCHA freq&quot;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hessian_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">hessian_data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Free energy curvature&quot;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span> <span class="s2">&quot;dotted&quot;</span><span class="p">)</span> <span class="c1"># Draw the zero</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature [K]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency [cm-1]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_Temp_Freq.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configurations</span><span class="p">))</span>
        <span class="c1">#plt.show()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span> <span class="o">=</span> <span class="mi">120</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hessian_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">hessian_data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">hessian_data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Free energy curvature&quot;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span> <span class="s2">&quot;dotted&quot;</span><span class="p">)</span> <span class="c1"># Draw the zero</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature [K]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$\omega^2$ [cm-2]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_Temp_Omeg.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configurations</span><span class="p">))</span>
        <span class="c1">#plt.show()</span>
</pre></div>
</div>
<p>Lets see the code:</p>
<ol class="arabic simple">
<li>The initialization is similar to the one we did for the “Search_instabilities”.</li>
<li>In “cycle_T” we condense in one function the calculation of the hessians in a loop for different temperatures. In the end, it searches for the lowest non acoustic frequency to save with the correspondent auxiliar sscha frequency.</li>
<li>Finally, in the last function of this object, we make a graphic output of the data.</li>
</ol>
<p>Lets put this object into the main function and calculate:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
  <span class="c1">#Setting the variables:</span>
  <span class="c1">#Setting the temperature in Kelvin:</span>
  <span class="n">Temperature</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="c1">#Setting the temparature range in Kelvin (6 steps from 50K to 300K):</span>
  <span class="n">Temperature_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
  <span class="c1">#Setting the number of configurations:</span>
  <span class="n">configuration_number</span> <span class="o">=</span> <span class="mi">50</span>
  <span class="c1">#Setting the names and location of the files:</span>
  <span class="n">Files_ForceFields</span> <span class="o">=</span> <span class="s2">&quot;ffield_dynq&quot;</span>
  <span class="n">Files_dyn_SnTe</span> <span class="o">=</span> <span class="s2">&quot;ffield_dynq&quot;</span>
  <span class="c1">#Set the number of irreducible q (reated to the supercell size):</span>
  <span class="n">nqirr</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="c1">#Setting the frequencies output file:</span>
  <span class="n">File_frequencies</span> <span class="o">=</span> <span class="s2">&quot;frequencies.dat&quot;</span>
  <span class="c1">#Setting the dynamical matrix output filename:</span>
  <span class="n">File_final_dyn</span> <span class="o">=</span> <span class="s2">&quot;final_sscha_T</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Temperature</span><span class="p">))</span>
  <span class="n">sobol</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">sobol_scatter</span> <span class="o">=</span> <span class="kc">False</span>

  <span class="c1">#We can comment this if we already made the sscha minimization</span>
  <span class="c1">#Calculus = SnTe_initial(Files_ForceFields,Files_dyn_SnTe,nqirr,configuration_number,sobol,sobol_scatter)</span>
  <span class="c1">#Calculus.ensemble_sscha(Temperature)</span>
  <span class="c1">#Calculus.minimizing(File_frequencies,File_final_dyn.format(int(Temperature)))</span>

  <span class="c1">#Now we can search for structural instabilities:</span>
  <span class="c1">#Unstable = Search_instabilities(Files_ForceFields,Files_dyn_SnTe,nqirr)</span>
  <span class="c1">#Unstable.load_dyn(File_final_dyn.format(Temperature),nqirr)</span>
  <span class="c1">#Unstable.ensemble_sscha(Temperature)</span>
  <span class="c1">#Unstable.calculate()</span>
  <span class="c1">#Unstable.hessian(Temperature)</span>

  <span class="c1">#</span>
  <span class="n">HessianVsTemperature</span> <span class="o">=</span> <span class="n">Hessian_Vs_Temperature</span><span class="p">(</span><span class="n">Temperature</span><span class="p">,</span><span class="n">Temperature_i</span><span class="p">,</span><span class="n">Files_ForceFields</span><span class="p">,</span><span class="n">configuration_number</span><span class="p">,</span><span class="n">sobol</span><span class="p">,</span><span class="n">sobol_scatter</span><span class="p">)</span>
  <span class="n">HessianVsTemperature</span><span class="o">.</span><span class="n">cycle_T</span><span class="p">(</span><span class="n">File_final_dyn</span><span class="p">,</span><span class="n">nqirr</span><span class="p">)</span>
  <span class="n">HessianVsTemperature</span><span class="o">.</span><span class="n">draw_figure</span><span class="p">()</span>

  <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
<p>We will simulate the temperatures up to room temperature (300 K) with steps of 50 K. Note, this will perform all the steps above 6 times, so it may take some minutes, depending on the PC (on a i3 from 2015, with one core, it took 2 hours).
If it takes too long you can reduce the number of steps by changing ‘Temperature_i = np.linspace(50, 300, 6)’.</p>
<p>We are using only 50 configurations in the ensemble. Note that this makes a fast calculation but is a low number. How the calculation changes with the number of configurations?</p>
<div class="figure" id="id5">
<span id="id3"></span><a class="reference internal image-reference" href="_images/Conf_Freq.png"><img alt="Freq. vs. Confs.." src="_images/Conf_Freq.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 2 </span><span class="caption-text">Evolution of the lowest ‘soft’ frequency in relation to the number of configurations in the ensemble with a stable configuration. The line is the media and the shade is the standard deviation.</span></p>
</div>
<p>As exercise, you can modify this “Hessian_Vs_Temperature” object by calling the “Search_instabilities” into the “cycle_T” function.</p>
</div>
<hr class="docutils" />
<div class="section" id="plot-the-hessian-phonon-dispersion">
<h3>Plot the Hessian phonon dispersion<a class="headerlink" href="#plot-the-hessian-phonon-dispersion" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index1.html">Documentation overview</a><ul>
      <li>Previous: <a href="index1.html" title="previous chapter">PYTHON-SSCHA USER GUIDE</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Lorenzo Monacelli.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="_sources/start.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>